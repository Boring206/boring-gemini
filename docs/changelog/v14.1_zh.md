# V14.1.0 - 存儲引擎革命與性能硬化

> **發布日期**: 2026-01-17  
> **代號**: "Async Phoenix" & "World-Class Architecture"

Boring V14.1.0 代表了核心存儲與韌性基礎設施的根本性架構演進，實現了**世界級的性能、可靠性與可觀測性**。

---

## 🚀 存儲引擎革命 (階段 1-5)

### 階段 1: 核心穩定化
- **並發優化**: 重構 `BrainManager.learn_pattern`，將嵌入向量計算移出全局寫鎖，減少 CPU 密集操作期間的競爭。
- **快速路徑對帳器**: 優化 `SystemReconciler.check_integrity`，當檢查點與當前帳本狀態匹配時跳過 O(N) 帳本掃描（基於序列的驗證）。
- **向前兼容鎖定**: 強化 `RobustLock` 以優雅處理未來的鎖文件格式（`len(parts) >= 2`），防止意外刪除來自新版本的有效鎖。

### 階段 2: SQLite WAL 遷移
- **事件帳本升級**: 從基於 JSONL 文件的存儲遷移到**帶有預寫日誌 (WAL) 的 SQLite**，以增強並發性、ACID 合規性和持久性。
- **自動遷移**: 從舊版 `events.jsonl` 到 `events.db` 的無縫單向遷移，並自動備份狀態（`.jsonl` → `.migrated`，`state.json` → `.bak`）。
- **基於序列的完整性**: 用整數序列 ID 替換文件字節偏移量，實現精確的狀態跟踪和對帳。
- **哈希鏈保留**: 維護 `prev_hash` 和 `checksum` 字段以進行加密完整性驗證。

### 階段 3: 異步與高性能
- **後台寫入器**: 實現了帶有批量 SQLite 提交的 `BackgroundWriter` 線程，將 API 響應時間與磁盤 I/O 解耦。
- **43 倍吞吐量提升**: 在異步模式下達到 **4373 RPS**，而同步模式僅 **102 RPS**（通過 `tests/stress/ledger_spam.py` 測量）。
- **用戶友好基準測試**: 新增 `boring doctor stress` 命令，用於生產就緒的性能驗證。
- **可配置異步模式**: 添加 `ASYNC_LEDGER_WRITE` 設置（默認：`True`），供用戶控制後台提交行為。

### 階段 4: 韌性與自我修復
- **熔斷器模式**: 使用具有自動恢復功能的韌性熔斷器保護關鍵路徑（LLM 調用、大腦檢索）免受級聯故障影響。
- **系統監督者**: 集中式組件健康監控，涵蓋後台線程、數據庫完整性和熔斷器狀態。
- **集成診斷**: `boring doctor check` 現在包含來自監督者的運營健康報告。

### 階段 5: 世界級可觀測性
- **關聯 ID**: 使用 `contextvars.ContextVar` 在日誌和遙測中實現端到端請求跟踪。
- **結構化 JSON 日誌**: 增強 `BoringJSONFormatter`，在每個日誌條目中包含關聯 ID，實現統一的跟踪關聯。
- **資源監控**: 通過 `TelemetryManager.record_resource_usage()` 自動跟踪 CPU 和 RAM 使用情況。
- **內核集成**: 所有流程執行現在都生成唯一的關聯 ID，實現完整的可觀測性。

---

## 📊 性能基準測試

**存儲引擎吞吐量**（通過 `boring doctor stress --count 1000` 測量）:
| 模式 | 吞吐量 (RPS) | 延遲 (1k 事件) | 提速 |
| :--- | :--- | :--- | :--- |
| **同步 (舊版)** | 102.7 RPS | 9.83s | 基準 |
| **異步 (新版)** | **4373.4 RPS** | **0.23s** | **快 42.9 倍** |

**用戶友好基準測試**: `boring doctor stress --count 100` 達到 **2149 RPS**（100 個事件耗時 0.047 秒）。

---

## 🔐 數據完整性

- **哈希鏈驗證**: 所有事件通過 `prev_hash` 和 `checksum` 字段維護加密完整性。
- **序列連續性**: 自動驗證確保事件序列中沒有間隙或重複。
- **安全遷移**: 成功導入 SQLite 後，舊版 JSONL 數據將保留為 `.migrated` 備份。
- **已驗證完整性**: `EventStore.verify_integrity()` 對所有事件執行完整的哈希鏈驗證。

---

## 🔬 新增 CLI 命令

| 命令 | 描述 |
|---------|-------------|
| `boring doctor stress [--count N] [--async/--sync]` | 存儲引擎高性能壓力測試（基準測試異步與同步吞吐量） |

---

## 🛠️ 技術改進

### 配置
- **異步存儲引擎**: 在 `config.py` 中添加 `ASYNC_LEDGER_WRITE: bool = True`，供用戶控制後台提交模式。
- **恢復舊版設置**: 通過恢復 `MAX_HOURLY_CALLS`、`PROMPT_FILE` 和通知設置修復了回歸問題。

### 韌性
- **熔斷器**: 新增 `src/boring/utils/resilience.py` 模塊，包含用於保護外部依賴的 `CircuitBreaker` 類。
- **監督者**: 新增 `src/boring/core/supervisor.py` 模塊，用於集中式組件健康監控。

### 可觀測性
- **關聯上下文**: 在 `telemetry.py` 中添加 `CORRELATION_ID` 上下文變量，用於請求跟踪。
- **增強日誌**: 更新 `logging.py`，將關聯 ID 注入所有 JSON 日誌條目。

---

## 🔧 修復

- **語法錯誤**: 修復 `reconciler.py` 中的重複 `else` 塊（第 136 行）導致的 `SyntaxError`。
- **配置回歸**: 恢復 `config.py` 中缺失的 `MAX_HOURLY_CALLS`、`PROMPT_FILE` 和通知設置。
- **向前兼容性**: 修改 `RobustLock._is_lock_valid` 以接受 `len(parts) >= 2` 的鎖格式，防止意外刪除未來版本的鎖文件。
- **導入錯誤**: 在 `events.py` 中添加缺失的 `uuid`、`time`、`json` 和 `hashlib` 導入。

---

## ⚠️ 破壞性更改

無。所有更改都向後兼容，並提供自動遷移。

---

## 📚 文檔

- **演練**: 添加了全面的 `walkthrough.md`，記錄了所有階段 1-5 的改進和基準測試結果。
- **任務跟踪**: 更新了 `task.md`，包含所有架構升級階段的完成狀態。
- **更新日誌**: 增強了 `CHANGELOG.md`，包含詳細的 v14.1.0 條目，涵蓋所有改進。

---

## 👥 貢獻者

感謝 Boring 團隊促成了這場存儲引擎革命！
