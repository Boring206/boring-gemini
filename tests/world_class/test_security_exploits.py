"""
üõ°Ô∏è Defense Verification Suite
This test suite verifies that security controls properly BLOCK attacks.
These tests MUST PASS for the system to be secure.
"""

from unittest.mock import patch

import pytest

from boring.core.config import settings
from boring.core.utils import TransactionalFileWriter, check_and_install_dependencies


@pytest.mark.asyncio
async def test_defense_rce_via_pip_blocked(tmp_path):
    """
    DEFENSE: Dependency Confusion RCE Blocked
    Goal: Ensure system asks for confirmation or denies install in headless mode.
    """
    malicious_code = "import os; import suspicious_package_v999"

    # Mock subprocess to ensure NO call is made
    with patch("subprocess.check_call") as mock_subprocess:
        # Mock typer.confirm to simulate User saying NO (or headless default)
        with patch("typer.confirm", side_effect=Exception("Headless")):  # or return_value=False
            check_and_install_dependencies(malicious_code)

            # Assert: pip install was NOT called
            assert mock_subprocess.call_count == 0, (
                "Security Failure: pip install was called despite lack of confirmation!"
            )
            print("\n[SUCCESS] RCE Blocked: Auto-install denied.")


@pytest.mark.asyncio
async def test_defense_path_traversal_blocked(tmp_path):
    """
    DEFENSE: File System Escape Blocked
    Goal: Ensure TransactionalFileWriter rejects paths outside project root.
    """
    # Setup fake root
    original_root = settings.PROJECT_ROOT
    settings.PROJECT_ROOT = tmp_path / "project"
    settings.PROJECT_ROOT.mkdir()

    try:
        target_file = tmp_path / "pwned.txt"
        attack_path = target_file  # Absolute path outside root

        # Execute
        # Should return False or raise Exception
        result = TransactionalFileWriter.write_text(attack_path, "hacked")

        # Verify
        assert result is False, "Security Failure: write_text returned True for outside path!"
        assert not target_file.exists(), "Security Failure: File was actually written to disk!"
        print("\n[SUCCESS] Path Traversal Blocked.")
    except Exception as e:
        # If it raised exception (ValueError), that's also a PASS
        if "outside project root" in str(e) or "Path Traversal" in str(e):
            print("\n[SUCCESS] Path Traversal Blocked (Exception Raised).")
        else:
            raise e
    finally:
        # Restore root
        settings.PROJECT_ROOT = original_root
